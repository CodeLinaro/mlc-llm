#!/usr/bin/env bash

set -e

COMMAND=( "$(which "$1")" )
shift
COMMAND=( "${COMMAND[@]}" "$@" )

if ! touch /this_is_writable_file_system; then
  echo "You can't write to your filesystem!"
  echo "If you are in Docker you should check you do not have too many images" \
      "with too many files in them. Docker has some issue with it."
  exit 1
else
  rm /this_is_writable_file_system
fi

getent group "${ENV_GROUP_ID}" || (
    # Ensure "${ENV_GROUP_NAME}" is not already some other gid inside container.
    if grep -q "^${ENV_GROUP_NAME}:" /etc/group; then
        ENV_GROUP_NAME="${ENV_GROUP_NAME}2"
    fi
    addgroup --force-badname --gid "${ENV_GROUP_ID}" "${ENV_GROUP_NAME}" >/dev/null)

getent passwd "${ENV_USER_ID}" || adduser --force-badname --gid "${ENV_GROUP_ID}" --uid "${ENV_USER_ID}" \
    --gecos "${ENV_USER_NAME} (generated by with_the_same_user script)" \
    --disabled-password --home "${ENV_BUILD_HOME}" --quiet "${ENV_USER_NAME}"

echo "${COMMAND[@]}"
runuser -u ${ENV_USER_NAME} -g ${ENV_GROUP_NAME} -- "${COMMAND[@]}"
